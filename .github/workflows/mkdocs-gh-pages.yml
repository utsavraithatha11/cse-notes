name: Deploy MkDocs to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material

      - name: Convert Obsidian image embeds
        run: |
          find docs -name "*.md" -exec \
          sed -i 's|!\[\[\(.*\)\]\]|![\1](attachments/\1)|g' {} +

      - name: Convert tags to bullet format
        run: |
          find docs -name "*.md" -type f | while read file; do
            awk '
            /^## Tags/ {
              print $0
              in_tags_section = 1
              tags_processed = 0
              next
            }
            
            in_tags_section && /^##/ {
              in_tags_section = 0
              print $0
              next
            }
            
            in_tags_section && !tags_processed && NF > 0 {
              if ($0 ~ /#/) {
                tags = $0
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", tags)
                if (tags !~ /^-[[:space:]]+`#/) {
                  print "- `" tags "`"
                } else {
                  print $0
                }
                tags_processed = 1
                next
              }
            }
            
            in_tags_section && tags_processed && /^[[:space:]]*$/ {
              print $0
              next
            }
            
            in_tags_section && tags_processed && NF > 0 && $0 ~ /#/ {
              tags = $0
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", tags)
              if (tags !~ /^-[[:space:]]+`#/) {
                print "- `" tags "`"
              } else {
                print $0
              }
              next
            }
            
            {
              print $0
            }
            ' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
          done

      - name: Build site
        run: mkdocs build --clean

      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force
